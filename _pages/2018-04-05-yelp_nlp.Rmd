---
title: "Yelp - NLP"
output: github_document
---


```{r setup, include=TRUE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(ggplot2)
library(dplyr)
library(reshape2)
library(ggridges)
library(tm)
library(stopwords)
library(purrr)

yelp <- fread("/media/ddantas/OS/udemy/PythonDataScience/Python-Data-Science-and-Machine-Learning-Bootcamp/Machine Learning Sections/Natural-Language-Processing/yelp.csv")
```

## Yelp Data Set

This dataset contains reviews information such as the rating, date of review and the text.

```{r}
str(yelp)
```

### Rating Distribution

```{r}
yelp%>%
  group_by(stars)%>%
  summarise(total=n())%>%
  ggplot(aes(x=stars,y=total))+
  geom_col(fill="navy")+theme_minimal()+xlab("# Ratings")+ylab("Stars")
```

Most of the reviews were 4 or 5 stars.

### Reviews

Below 3 examples of reviews.

```{r}
yelp[23:25,text]
```

How long are these reviews?

```{r, message=FALSE}
yelp[,review_len:=nchar(text)]

ggplot(yelp,aes(x=review_len))+
  geom_histogram(fill="navy")+theme_minimal()+xlab("Review Length")
```

Most of them are lower than 1k characters.

### Very Short Reviews

Example of very short reviews.

```{r}
yelp[review_len<15,text]
```

Some of them are very useful though. Sometimes is better to read 'No good' or 'Excellent' than those long texts.

### The Longest Review

In this dataset the longest review have 5,003 characters. Feel free to read :p

```{r}
cat(yelp[review_len==5003,text])
```

### The Length by Rating

```{r, message=FALSE}
# yelp%>%
# ggplot(aes(x=log(review_len), group=as.factor(stars)))+
#   geom_density(aes(fill=as.factor(stars)),alpha=0.6)+
#   theme_minimal()+guides(fill=guide_legend(title="Stars"))+xlab("log Review Length")

yelp%>%
ggplot(aes(x=log(review_len), y=as.factor(stars)))+
  geom_density_ridges(rel_min_height = 0.01,aes(fill=as.factor(stars)))+
  geom_vline(xintercept = 6.25, lty=2, colour="red")+
  theme_minimal()+ylab("Stars")+xlab("log Review Length")+guides(fill=FALSE)

yelp[stars%in%c(1,5)]%>%
ggplot(aes(x=log(review_len), group=as.factor(stars)))+
  geom_density(aes(fill=as.factor(stars)),alpha=0.6)+
  theme_minimal()+guides(fill=guide_legend(title="Stars"))+xlab("log Review Length")


```

It seems that 5 stars ratings tend to have slightly less characters than others.

It seems that longer text have a slightly tendency to be a 1 star review. But I don't think it would be useful. Let's see though.

### Text processing

* Convert letters to lowercase. 
* Remove punctuation and *stopwords*.

```{r}
# Remove punctuation
yelp[,text2:=tolower(gsub("[[:punct:]]","",text))]

# Remove stopwords
t<-unlist(
  map(
    as.list(yelp[,text2]),
    ~tm_map(Corpus(VectorSource(.x)),removeWords,stopwords())[[1]]$content
    )
)

yelp[,text2:=t]
```


### Text analysis

Let's start very simple. Only analyzing the presence of word "good".

```{r, message=TRUE}
yelp[,good:=grepl("good", text,ignore.case = TRUE)]

yelp%>%
  group_by(good)%>%
  summarise(total=n())

dcast(yelp%>%
  group_by(stars)%>%
  mutate(total_stars=n())%>%
  group_by(stars,good)%>%
  summarise(total=round(100*n()/mean(total_stars),2)),formula = stars~good)%>%
  rename(`Stars \\ Word Good`=stars)


dcast(yelp%>%
  group_by(good)%>%
  mutate(total_good=n())%>%
  group_by(good,stars)%>%
  summarise(total=round(100*n()/mean(total_good),2)),formula = good~stars)%>%
  rename(`Word Good \\ Stars`=good)
```



